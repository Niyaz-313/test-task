@startuml
actor "Владелец/Субаккаунт" as User
participant "НКМТ" as NKMT
participant "Pcat" as Pcat
participant "ВетИС.API" as ВетИС.API
participant "Меркурий" as Mercury
participant "СТП Меркурий" as STP.Mercury

== INT.01: Создание и обновление номенклатуры владельца GTIN ==

group Инициация обновления данных
NKMT -> ВетИС.API: Запрос с изменения GTIN
ВетИС.API -> NKMT: Передача идентификатора запроса
end
ВетИС.API -> Mercury: Изменения GTIN


Mercury -> Pcat: Запрос данных карточки по полученным GTIN
Pcat -> NKMT: Ретрансляция запроса от Меркурий
NKMT -> Pcat: Передача данных карточки
Pcat -> Mercury: Ретрансляция данных карточки
Mercury -> Mercury: Создание/Обновление карточки (и владельца, и субаккаунтов)
Mercury -> ВетИС.API: Передача статуса по результатам обработки данных


loop Запрос статуса результата
    NKMT -> ВетИС.API: Запрос статуса
    ВетИС.API -> NKMT: Статус/Ошибка
end

== INT.02: Привязка номенклатуры к карточке в НКМТ ==

group Инициация привязки данных
NKMT -> ВетИС.API: Запрос с GTIN и ProductItem ID
ВетИС.API -> NKMT: Передача идентификатора запроса
end
ВетИС.API -> Mercury: GTIN и ProductItem ID


Mercury -> Pcat: Запрос данных по полученным GTIN
Pcat -> NKMT: Ретрансляция запроса от Меркурий
NKMT -> Pcat: Передача расширенных данных
Pcat -> Mercury: Ретрансляция данных для связи
Mercury -> Mercury: Проверка атрибута ProductItem ID
Mercury -> Mercury: Установка признака синхронизации
Mercury -> Mercury: Сохранение GTIN
Mercury -> ВетИС.API: Передача статуса по результатам обработки данных

loop Запрос статуса результата
    NKMT -> ВетИС.API: Запрос статуса
    ВетИС.API -> NKMT: Статус/Ошибка
end

== INT.03: Проверка версии номенклатуры ==

group Инициация проверки версии
NKMT -> ВетИС.API: Запрос проверки версий (передаются:GUID, UUID, ИНН влд, ИНН суб)
ВетИС.API -> NKMT: Передача идентификатора запроса
end

alt Проверка версии
    group Номенклатуры созданные на исторических данных.
        group Процесс валидации и синхронизации в статусе "модерация".
            ВетИС.API -> Mercury: Отправка сведений карточки с GUID (статус "модерация").
            Mercury -> Mercury: Найдена карточка по GUID
            Mercury -> Pcat: Запрос данных карточки по полученным данным
            Pcat -> NKMT: Ретрансляция запроса от Меркурий
            NKMT -> Pcat: Передача атрибутов карточки
            Pcat -> Mercury: Ретрансляция атрибутов карточки
            Mercury -> Mercury: Валидация данных (без блокировки, без синхронизации).
            Mercury -> ВетИС.API: Результаты проверки + UUID
            loop Запрос статуса результата
            NKMT -> ВетИС.API: Запрос статуса
            ВетИС.API -> NKMT: Статус/Ошибка
            end
            NKMT -> NKMT: Обновление карточки на основе данных\n после валдации, повторная отправка на Модерацию, \n пока не перейдет в статус на подписание.
            end
            group Процесс валидации и синхронизации в статусе "Подписан"
            ВетИС.API -> Mercury: Отправка сведений карточки (статус "подписан").
            Mercury -> Mercury: Найдена карточка по GUID
            Mercury -> Pcat: Запрос данных карточки по полученным данным
            Pcat -> NKMT: Ретрансляция запроса от Меркурий
            NKMT -> Pcat: Передача атрибутов карточки
            Pcat -> Mercury: Ретрансляция атрибутов карточки
            Mercury -> Mercury: Перезапись карточки товара, \n Установка признака синхронизации,\n Блокировка карточки
            Mercury -> ВетИС.API: Принято без валидирования + UUID
            loop Запрос статуса результата
            NKMT -> ВетИС.API: Запрос статуса.
            ВетИС.API -> NKMT: Статус/Ошибка.
            end
        end
    end
    
    group Номенклатуры созданные на Новых данных
        group Процесс валидации и синхронизации в статусе "модерация".
            ВетИС.API -> Mercury: Отправка сведений карточки с GTIN + ИНН (статус "модерация")
            Mercury -> Mercury: Поиск по GTIN + ИНН-владельца
            alt Одна или более номенклатур
            Mercury -> Mercury: Найдена одна или более номенклатур
            Mercury -> Mercury: Подготовка списка с найденными GUID
            Mercury -> Pcat: Передача списка с уточнением,\n требуется ли создать новую номенклатуру или\n связать карточку товара с существующей 
            Pcat -> NKMT: Ретрансляция запроса от Меркурий
            end
            Mercury -> Mercury: Не найдено GUID по таким GTIN + ИНН-владельца
            Mercury -> Pcat: Запрос данных карточки по полученным данным
            Pcat -> NKMT: Ретрансляция запроса от Меркурий
            NKMT -> Pcat: Передача атрибутов карточки
            Pcat -> Mercury: Ретрансляция атрибутов карточки
            Mercury -> Mercury: Валидация данных (Создание/обновление черновика,\n блокировка, без синхронизации)
            Mercury -> ВетИС.API: Результаты проверки + UUID и GUID
            loop Запрос статуса результата.
            NKMT -> ВетИС.API: Запрос статуса
            ВетИС.API -> NKMT: Статус/Ошибка
            end
            NKMT -> NKMT: Обновление карточки на основе данных\n после валдации, повторная отправка на Модерацию, \n пока не перейдет в статус на подписание.
            end
            group Процесс валидации и синхронизации в статусе "Подписан"
            ВетИС.API -> Mercury: Отправка сведений карточки (статус "подписан").
            Mercury -> Mercury: Найдена карточка по UUID
            Mercury -> Pcat: Запрос данных карточки по полученным данным
            Pcat -> NKMT: Ретрансляция запроса от Меркурий
            NKMT -> Pcat: Передача атрибутов карточки
            Pcat -> Mercury: Ретрансляция атрибутов карточки
            Mercury -> Mercury: Перезапись карточки товара, \n Установка признака синхронизации,\n Блокировка карточки
            Mercury -> ВетИС.API: Принято без валидирования + UUID и GUID
            loop Запрос статуса результата
            NKMT -> ВетИС.API: Запрос статуса
            ВетИС.API -> NKMT: Статус/Ошибка
            end
        end
    end
    
alt Поиск номенклатуры субаккаунта в процессе Модерации
    ВетИС.API -> Mercury: Передача версии GTIN на проверку количества субаккаунтов
    Mercury -> Mercury: Поиск всех номенклатур субаккаунтов
    alt Одна номенклатура
    Mercury -> Mercury: Найдена одна номенклатур субаккаунта
    Mercury -> Mercury: Продолжить валидирование данных
    Mercury -> ВетИС.API: Результаты проверки
    end
    alt Более одной номенклатуры
    Mercury -> Mercury: Найдена более одной номенклатуры субаккаунта
    Mercury -> STP.Mercury: Обращение в СТП Меркурий.
    Mercury -> ВетИС.API: Уведомление о создании обращения в СТП + номер обращения.
    end
    loop Запрос статуса результата
    NKMT -> ВетИС.API: Запрос статуса
    ВетИС.API -> NKMT: Статус/Ошибка
    end
end



== INT.04: Решение обращений в СТП ==

User -> STP.Mercury: Обращение о проблемах синхронизации 
STP.Mercury -> Mercury: Запрос актуальных данных по GTIN
Mercury -> Pcat: Отправка запроса в Pcat для получения сведений
Pcat -> NKMT: Ретрансляция запроса от Меркурий
NKMT -> Pcat: Предоставление актуальных данных
Pcat -> Mercury: Ретрансляция актуальных данных
Mercury -> Mercury: Создание/Обновление номенклатуры


alt Синхронизировано
    Mercury -> STP.Mercury: Подтверждение Создания/обновления и синхронизации
else Найдено более одной номенклатуры
    Mercury -> STP.Mercury: Обращение в СТП Меркурий
end

STP.Mercury -> User: Проблема решена/Необходимо оставить только одну номенклатуру

== INT.05: Получение атрибутов номенклатуры из Меркурий ==

User -> NKMT: Создание карточки товара с ProductItem ID
NKMT -> ВетИС.API: Запрос атрибутов по ProductItem ID
ВетИС.API -> Mercury: Запрос атрибутов по ProductItem ID
Mercury -> Mercury: Поиск данных карточки
Mercury -> ВетИС.API: Передача данных карточки
ВетИС.API -> NKMT: Ретрансляция данных
NKMT -> NKMT: Заполнение карточки товара


== INT.06: Обновление номенклатуры субаккаунтов при изменениях GTIN ==

group Инициация обработки изменений
NKMT -> ВетИС.API: Передача сведений по изменениям (ИНН владельца, ИНН-субаккаунта, список GTIN)
ВетИС.API -> NKMT: Передача идентификатора запроса
end
ВетИС.API -> Mercury: Данные карточки (ИНН владельца, ИНН-субаккаунта, список GTIN)
Mercury -> Mercury: Поиск измененных карточек субаккаунтов
note right: Исходим из того, что в списке ИНН-субаккаунтов только актуальные данные.\n Которые были, но пропали- блокируем.\n Которых не было - создаем.
Mercury -> Mercury: Создание/обновление/блокирование номенклатуры субаккаунта\n по найденной карточке Владельца
Mercury -> ВетИС.API: Передача статуса по результатам обработки данных


loop Запрос статуса результата
    NKMT -> ВетИС.API: Запрос статуса
    ВетИС.API -> NKMT: Статус/Ошибка
end
@enduml
